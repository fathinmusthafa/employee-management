<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Departments Management</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        .card { box-shadow: 0 0 10px rgba(0,0,0,.1); border: none; border-radius: 10px; }
        .btn-action { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .modal-header { background-color: #0d6efd; color: white; }
        .required::after { content: " *"; color: red; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="fas fa-users"></i> Employee Management System
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/employees">Employees</a></li>
                <li class="nav-item"><a class="nav-link active" href="/departments">Departments</a></li>
                <li class="nav-item"><a class="nav-link" href="/salaries">Salaries</a></li>
                <li class="nav-item"><a class="nav-link" href="/titles">Titles</a></li>
                <li class="nav-item"><a class="nav-link" href="/dept-emp">Dept Emp</a></li>
                <li class="nav-item"><a class="nav-link" href="/dept-manager">Dept Manager</a></li>
                <li class="nav-item"><a class="nav-link" href="/swagger-ui.html" target="_blank">API Docs</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white py-3">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-0"><i class="fas fa-building"></i> Department List</h4>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#departmentModal" onclick="openAddModal()">
                                <i class="fas fa-plus"></i> Add Department
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <table id="departmentsTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                        <tr>
                            <th>Department No</th>
                            <th>Department Name</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="departmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Department</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    <div class="mb-3">
                        <label for="deptNo" class="form-label required">Department Number</label>
                        <input type="text" class="form-control" id="deptNo" maxlength="4" required>
                        <small class="form-text text-muted">Must be exactly 4 characters</small>
                    </div>
                    <div class="mb-3">
                        <label for="deptName" class="form-label required">Department Name</label>
                        <input type="text" class="form-control" id="deptName" maxlength="40" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDepartment()">Save</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let table;
    let isEditMode = false;
    let currentDeptNo = null;

    $(document).ready(function() {
        table = $('#departmentsTable').DataTable({
            ajax: {
                url: '/api/departments',
                dataSrc: function(json) {
                    if (json._embedded && json._embedded.departmentDTOList) {
                        return json._embedded.departmentDTOList;
                    }
                    return json;
                }
            },
            columns: [
                { data: 'deptNo' },
                { data: 'deptName' },
                {
                    data: null,
                    orderable: false,
                    render: function(data, type, row) {
                        return `
                            <button class="btn btn-sm btn-warning btn-action" onclick="editDepartment('${row.deptNo}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteDepartment('${row.deptNo}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        `;
                    }
                }
            ]
        });
    });

    function openAddModal() {
        isEditMode = false;
        currentDeptNo = null;
        $('#modalTitle').text('Add Department');
        $('#departmentForm')[0].reset();
        $('#deptNo').prop('readonly', false);
    }

    function editDepartment(deptNo) {
        isEditMode = true;
        currentDeptNo = deptNo;
        $('#modalTitle').text('Edit Department');

        $.get(`/api/departments/${deptNo}`, function(data) {
            $('#deptNo').val(data.deptNo).prop('readonly', true);
            $('#deptName').val(data.deptName);
            $('#departmentModal').modal('show');
        }).fail(function() {
            Swal.fire('Error', 'Failed to load department data', 'error');
        });
    }

    function saveDepartment() {
        const formData = {
            deptNo: $('#deptNo').val().toUpperCase(),
            deptName: $('#deptName').val()
        };

        if (!formData.deptNo || formData.deptNo.length !== 4 || !formData.deptName) {
            Swal.fire('Error', 'Please fill all required fields correctly', 'error');
            return;
        }

        const url = isEditMode ? `/api/departments/${currentDeptNo}` : '/api/departments';
        const method = isEditMode ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                $('#departmentModal').modal('hide');
                table.ajax.reload();
                Swal.fire('Success',
                         isEditMode ? 'Department updated successfully' : 'Department added successfully',
                         'success');
            },
            error: function(xhr) {
                const error = xhr.responseJSON;
                const message = error && error.message ? error.message : 'An error occurred';
                Swal.fire('Error', message, 'error');
            }
        });
    }

    function deleteDepartment(deptNo) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/departments/${deptNo}`,
                    method: 'DELETE',
                    success: function() {
                        table.ajax.reload();
                        Swal.fire('Deleted!', 'Department has been deleted.', 'success');
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON;
                        const message = error && error.message ? error.message : 'Failed to delete department';
                        Swal.fire('Error', message, 'error');
                    }
                });
            }
        });
    }
</script>
</body>
</html>