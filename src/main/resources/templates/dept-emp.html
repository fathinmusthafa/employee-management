<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department-Employee Management</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        .card { box-shadow: 0 0 10px rgba(0,0,0,.1); border: none; border-radius: 10px; }
        .btn-action { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .modal-header { background-color: #0d6efd; color: white; }
        .required::after { content: " *"; color: red; }
        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="fas fa-users"></i> Employee Management System
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/employees">Employees</a></li>
                <li class="nav-item"><a class="nav-link" href="/departments">Departments</a></li>
                <li class="nav-item"><a class="nav-link" href="/salaries">Salaries</a></li>
                <li class="nav-item"><a class="nav-link" href="/titles">Titles</a></li>
                <li class="nav-item"><a class="nav-link active" href="/dept-emp">Dept-Employee</a></li>
                <li class="nav-item"><a class="nav-link" href="/dept-manager">Dept-Manager</a></li>
                <li class="nav-item"><a class="nav-link" href="/swagger-ui.html" target="_blank">API Docs</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <!-- Info Card -->
<!--    <div class="row">-->
<!--        <div class="col-12">-->
<!--        </div>-->
<!--    </div>-->

    <!-- Main Card -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white py-3">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-0"><i class="fas fa-users-cog"></i> Department Assignments</h4>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-success me-2" onclick="filterCurrent()">
                                <i class="fas fa-filter"></i> Current Only
                            </button>
                            <button class="btn btn-secondary me-2" onclick="clearFilter()">
                                <i class="fas fa-redo"></i> All Records
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#deptEmpModal" onclick="openAddModal()">
                                <i class="fas fa-plus"></i> Assign Employee
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <table id="deptEmpTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                        <tr>
                            <th>Employee No</th>
                            <th>Department</th>
                            <th>From Date</th>
                            <th>To Date</th>
                            <th>Status</th>
                            <th>Duration (days)</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assignment Modal -->
<div class="modal fade" id="deptEmpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Assign Employee to Department</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deptEmpForm">
                    <div class="mb-3">
                        <label for="empNo" class="form-label required">Employee Number</label>
                        <input type="number" class="form-control" id="empNo" required>
                        <small class="form-text text-muted">Enter valid employee number</small>
                    </div>
                    <div class="mb-3">
                        <label for="deptNo" class="form-label required">Department Number</label>
                        <input type="text" class="form-control" id="deptNo" maxlength="4" required>
                        <small class="form-text text-muted">4-character department code (e.g., d001)</small>
                    </div>
                    <div class="mb-3">
                        <label for="fromDate" class="form-label required">From Date</label>
                        <input type="date" class="form-control" id="fromDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="toDate" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="toDate" required>
                        <small class="form-text text-muted">Leave empty for current </small>

                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDeptEmp()">Save Assignment</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let table;
    let isEditMode = false;
    let currentEmpNo = null;
    let currentDeptNo = null;

    $(document).ready(function() {
        table = $('#deptEmpTable').DataTable({
            ajax: {
                url: '/api/dept-emp',
                dataSrc: function(json) {
                    if (json._embedded && json._embedded.deptEmpDTOList) {
                        return json._embedded.deptEmpDTOList;
                    }
                    return json;
                },
                error: function(xhr, error, thrown) {
                    console.error('Error loading data:', error);
                    Swal.fire('Error', 'Failed to load department assignments', 'error');
                }
            },
            columns: [
                { data: 'empNo' },
                { data: 'deptNo' },
                { data: 'fromDate' },
                {
                    data: 'toDate',
                    render: function(data) {
                        if (data === null) {
                            return '<span class="badge bg-success">Current</span>';
                        }
                        return data;
                    }
                },
                {
                    data: 'toDate',
                    render: function(data) {
                        const today = new Date().toISOString().split('T')[0];
                        if (data === null || data >= today) {
                            return '<span class="badge bg-success">Active</span>';
                        }
                        return '<span class="badge bg-secondary">Historical</span>';
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        const from = new Date(row.fromDate);
                        const to = row.toDate === null ? new Date() : new Date(row.toDate);
                        const days = Math.floor((to - from) / (1000 * 60 * 60 * 24));
                        return days + ' days';
                    }
                },
                {
                    data: null,
                    orderable: false,
                    render: function(data, type, row) {
                        return `
                            <button class="btn btn-sm btn-info btn-action" onclick="viewEmployee(${row.empNo})" title="View Employee">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="btn btn-sm btn-info btn-action" onclick="viewDepartment('${row.deptNo}')" title="View Department">
                                <i class="fas fa-building"></i>
                            </button>
                            <button class="btn btn-sm btn-warning btn-action" onclick="editDeptEmp(${row.empNo}, '${row.deptNo}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteDeptEmp(${row.empNo}, '${row.deptNo}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    }
                }
            ]
        });
    });

    function openAddModal() {
        isEditMode = false;
        currentEmpNo = null;
        currentDeptNo = null;
        $('#modalTitle').text('Assign Employee to Department');
        $('#deptEmpForm')[0].reset();
        $('#empNo').prop('readonly', false);
        $('#deptNo').prop('readonly', false);
        $('#toDate').prop('readonly', false);
    }

    function editDeptEmp(empNo, deptNo) {
        isEditMode = true;
        currentEmpNo = empNo;
        currentDeptNo = deptNo;
        $('#modalTitle').text('Edit Department Assignment');

        $.get(`/api/dept-emp/employee/${empNo}`, function(response) {
            const assignments = response._embedded ? response._embedded.deptEmpDTOList : response;
            const assignment = assignments.find(a => a.deptNo === deptNo);

            if (assignment) {
                $('#empNo').val(assignment.empNo).prop('readonly', true);
                $('#deptNo').val(assignment.deptNo).prop('readonly', true);
                $('#fromDate').val(assignment.fromDate);
                $('#toDate').val(assignment.toDate);
                $('#deptEmpModal').modal('show');
            }
        }).fail(function() {
            Swal.fire('Error', 'Failed to load assignment data', 'error');
        });
    }

    function saveDeptEmp() {
        const formData = {
            empNo: parseInt($('#empNo').val()),
            deptNo: $('#deptNo').val().trim(),
            fromDate: $('#fromDate').val(),
            toDate: $('#toDate').val()
        };

        if (!formData.empNo || !formData.deptNo || !formData.fromDate ) {
            Swal.fire('Error', 'Please fill all required fields', 'error');
            return;
        }

        if (formData.deptNo.length !== 4) {
            Swal.fire('Error', 'Department number must be exactly 4 characters', 'error');
            return;
        }

        const url = isEditMode
            ? `/api/dept-emp/${currentEmpNo}/${currentDeptNo}`
            : '/api/dept-emp';
        const method = isEditMode ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                $('#deptEmpModal').modal('hide');
                table.ajax.reload();
                Swal.fire('Success',
                         isEditMode ? 'Assignment updated successfully' : 'Employee assigned successfully',
                         'success');
            },
            error: function(xhr) {
                const error = xhr.responseJSON;
                const message = error && error.message ? error.message : 'An error occurred';
                Swal.fire('Error', message, 'error');
            }
        });
    }

    function deleteDeptEmp(empNo, deptNo) {
        Swal.fire({
            title: 'Are you sure?',
            text: "This will remove the employee from this department!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/dept-emp/${empNo}/${deptNo}`,
                    method: 'DELETE',
                    success: function() {
                        table.ajax.reload();
                        Swal.fire('Removed!', 'Assignment has been removed.', 'success');
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON;
                        const message = error && error.message ? error.message : 'Failed to remove assignment';
                        Swal.fire('Error', message, 'error');
                    }
                });
            }
        });
    }

    function filterCurrent() {
        const today = new Date().toISOString().split('T')[0];
        table.column(3).search('Current|' + today, true, false).draw();
    }

    function clearFilter() {
        table.search('').columns().search('').draw();
    }

    function viewEmployee(empNo) {
        window.open(`/employees?empNo=${empNo}`, '_blank');
    }

    function viewDepartment(deptNo) {
        window.open(`/departments?deptNo=${deptNo}`, '_blank');
    }

</script>
</body>
</html>