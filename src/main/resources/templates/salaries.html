<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salaries Management</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        .card { box-shadow: 0 0 10px rgba(0,0,0,.1); border: none; border-radius: 10px; }
        .btn-action { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .modal-header { background-color: #0d6efd; color: white; }
        .required::after { content: " *"; color: red; }
        .salary-badge { font-size: 0.9rem; font-weight: 600; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="fas fa-users"></i> Employee Management System
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/employees">Employees</a></li>
                <li class="nav-item"><a class="nav-link" href="/departments">Departments</a></li>
                <li class="nav-item"><a class="nav-link active" href="/salaries">Salaries</a></li>
                <li class="nav-item"><a class="nav-link" href="/titles">Titles</a></li>
                <li class="nav-item"><a class="nav-link" href="/dept-emp">Dept Emp</a></li>
                <li class="nav-item"><a class="nav-link" href="/dept-manager">Dept Manager</a></li>
                <li class="nav-item"><a class="nav-link" href="/swagger-ui.html" target="_blank">API Docs</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white py-3">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-0"><i class="fas fa-money-bill-wave"></i> Employee Salaries</h4>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#salaryModal" onclick="openAddModal()">
                                <i class="fas fa-plus"></i> Add Salary
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <table id="salariesTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                        <tr>
                            <th>Employee No</th>
                            <th>Salary</th>
                            <th>From Date</th>
                            <th>To Date</th>
                            <th>Status</th>
                            <th>Duration (days)</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Salary Modal -->
<div class="modal fade" id="salaryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Salary</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="salaryForm">
                    <div class="mb-3">
                        <label for="empNo" class="form-label required">Employee Number</label>
                        <input type="number" class="form-control" id="empNo" required>
                    </div>
                    <div class="mb-3">
                        <label for="salary" class="form-label required">Salary Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="salary" min="0" required>
                        </div>
                        <small class="form-text text-muted">Enter annual salary</small>
                    </div>
                    <div class="mb-3">
                        <label for="fromDate" class="form-label required">From Date</label>
                        <input type="date" class="form-control" id="fromDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="toDate" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="toDate">
                        <small class="form-text text-muted">Leave empty for current</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSalary()">Save</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let table;
    let isEditMode = false;
    let currentEmpNo = null;
    let currentFromDate = null;

    $(document).ready(function() {
        table = $('#salariesTable').DataTable({
            ajax: {
                url: '/api/salaries',
                dataSrc: function(json) {
                    // Handle HATEOAS response
                    if (json._embedded && json._embedded.salaryDTOList) {
                        return json._embedded.salaryDTOList;
                    }
                    return json;
                },
                error: function(xhr, error, thrown) {
                    console.error('Error loading data:', error);
                    Swal.fire('Error', 'Failed to load salaries', 'error');
                }
            },
            columns: [
                { data: 'empNo' },
                {
                    data: 'salary',
                    render: function(data) {
                        return '<span class="salary-badge text-success">$' +
                               parseInt(data).toLocaleString() + '</span>';
                    }
                },
                { data: 'fromDate' },
                {
                    data: 'toDate',
                    render: function(data) {
                        if (data == null ) {
                            return '<span class="badge bg-success">Current</span>';
                        }
                        return data;
                    }
                },
                {
                    data: 'toDate',
                    render: function(data) {
                        const today = new Date().toISOString().split('T')[0];
                        if (data == null || data >= today) {
                            return '<span class="badge bg-success">Active</span>';
                        }
                        return '<span class="badge bg-secondary">Historical</span>';
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        const from = new Date(row.fromDate);
                        const to = row.toDate === null ? new Date() : new Date(row.toDate);
                        const days = Math.floor((to - from) / (1000 * 60 * 60 * 24));
                        return days + ' days';
                    }
                },
                {
                    data: null,
                    orderable: false,
                    render: function(data, type, row) {
                        return `
                            <button class="btn btn-sm btn-info btn-action" onclick="viewEmployee(${row.empNo})">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="btn btn-sm btn-warning btn-action" onclick="editSalary(${row.empNo}, '${row.fromDate}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteSalary(${row.empNo}, '${row.fromDate}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    }
                }
            ]
        });
    });

    function openAddModal() {
        isEditMode = false;
        currentEmpNo = null;
        currentFromDate = null;
        $('#modalTitle').text('Add Salary');
        $('#salaryForm')[0].reset();
        $('#empNo').prop('readonly', false);
        $('#fromDate').prop('readonly', false);
        $('#toDate').prop('readonly', false);
    }

    function editSalary(empNo, fromDate) {
        isEditMode = true;
        currentEmpNo = empNo;
        currentFromDate = fromDate;
        $('#modalTitle').text('Edit Salary');

        // Fetch salary data
        $.get(`/api/salaries/employee/${empNo}`, function(response) {
            const salaries = response._embedded ? response._embedded.salaryDTOList : response;
            const salary = salaries.find(s => s.fromDate === fromDate);

            if (salary) {
                $('#empNo').val(salary.empNo).prop('readonly', true);
                $('#salary').val(salary.salary);
                $('#fromDate').val(salary.fromDate).prop('readonly', true);
                $('#toDate').val(salary.toDate);
                $('#salaryModal').modal('show');
            }
        }).fail(function() {
            Swal.fire('Error', 'Failed to load salary data', 'error');
        });
    }

    function saveSalary() {
        const formData = {
            empNo: parseInt($('#empNo').val()),
            salary: parseInt($('#salary').val()),
            fromDate: $('#fromDate').val(),
            toDate: $('#toDate').val()
        };

        if (!formData.empNo || !formData.salary || !formData.fromDate) {
            Swal.fire('Error', 'Please fill all required fields', 'error');
            return;
        }

        if (formData.salary <= 0) {
            Swal.fire('Error', 'Salary must be greater than 0', 'error');
            return;
        }

        const url = isEditMode
            ? `/api/salaries/${currentEmpNo}/${currentFromDate}`
            : '/api/salaries';
        const method = isEditMode ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                $('#salaryModal').modal('hide');
                table.ajax.reload();
                Swal.fire('Success',
                         isEditMode ? 'Salary updated successfully' : 'Salary added successfully',
                         'success');
            },
            error: function(xhr) {
                const error = xhr.responseJSON;
                const message = error && error.message ? error.message : 'An error occurred';
                Swal.fire('Error', message, 'error');
            }
        });
    }

    function deleteSalary(empNo, fromDate) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/salaries/${empNo}/${fromDate}`,
                    method: 'DELETE',
                    success: function() {
                        table.ajax.reload();
                        Swal.fire('Deleted!', 'Salary has been deleted.', 'success');
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON;
                        const message = error && error.message ? error.message : 'Failed to delete salary';
                        Swal.fire('Error', message, 'error');
                    }
                });
            }
        });
    }

    function viewEmployee(empNo) {
        window.location.href = `/employees?empNo=${empNo}`;
    }

</script>
</body>
</html>