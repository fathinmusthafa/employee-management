<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Management System</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- DataTables CSS -->
    <link
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }
      .navbar {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .card {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 10px;
      }
      .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }
      .modal-header {
        background-color: #0d6efd;
        color: white;
      }
      .required::after {
        content: " *";
        color: red;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">
          <i class="fas fa-users"></i> Employee Management System
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="/employees">Employees</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/departments">Departments</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/salaries">Salaries</a>
            </li>
              <li class="nav-item"><a class="nav-link" href="/titles">Titles</a></li>
              <li class="nav-item"><a class="nav-link" href="/dept-emp">Dept Emp</a></li>
              <li class="nav-item"><a class="nav-link" href="/dept-manager">Dept Manager</a></li>
            <li class="nav-item">
              <a class="nav-link" href="/swagger-ui.html" target="_blank"
                >API Docs</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-white py-3">
              <div class="row align-items-center">
                <div class="col">
                  <h4 class="mb-0">
                    <i class="fas fa-user-tie"></i> Employee List
                  </h4>
                </div>
                <div class="col-auto">
                  <button
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#employeeModal"
                    onclick="openAddModal()"
                  >
                    <i class="fas fa-plus"></i> Add Employee
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <table
                id="employeesTable"
                class="table table-striped table-hover"
                style="width: 100%"
              >
                <thead>
                  <tr>
                    <th>Employee No</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Gender</th>
                    <th>Birth Date</th>
                    <th>Hire Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Data will be loaded via AJAX -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Employee Modal -->
    <div class="modal fade" id="employeeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Add Employee</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="employeeForm">
              <div class="mb-3">
                <label for="empNo" class="form-label required"
                  >Employee Number</label
                >
                <input type="number" class="form-control" id="empNo" required />
              </div>
              <div class="mb-3">
                <label for="firstName" class="form-label required"
                  >First Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="firstName"
                  maxlength="14"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="lastName" class="form-label required"
                  >Last Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="lastName"
                  maxlength="16"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="gender" class="form-label required">Gender</label>
                <select class="form-select" id="gender" required>
                  <option value="">Select Gender</option>
                  <option value="M">Male</option>
                  <option value="F">Female</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="birthDate" class="form-label required"
                  >Birth Date</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="birthDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="hireDate" class="form-label required"
                  >Hire Date</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="hireDate"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveEmployee()"
            >
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      let table;
      let isEditMode = false;
      let currentEmpNo = null;

      //   link = "http://localhost:8080";

      $(document).ready(function () {
        // Initialize DataTable
        table = $("#employeesTable").DataTable({
          ajax: {
            url: "http://localhost:8080/api/employees",
            dataSrc: function (json) {
              // Extract data from HATEOAS response
              if (json._embedded && json._embedded.employeeDTOList) {
                return json._embedded.employeeDTOList.map((item) => item);
              }
              return json;
            },
            error: function (xhr, error, thrown) {
              console.error("Error loading data:", error);
              Swal.fire("Error", "Failed to load employees", "error");
            },
          },
          columns: [
            { data: "empNo" },
            { data: "firstName" },
            { data: "lastName" },
            { data: "gender" },
            { data: "birthDate" },
            { data: "hireDate" },
            {
              data: null,
              orderable: false,
              render: function (data, type, row) {
                return `
                                <button class="btn btn-sm btn-warning btn-action" onclick="editEmployee(${row.empNo})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" onclick="deleteEmployee(${row.empNo})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            `;
              },
            },
          ],
          responsive: true,
          pageLength: 10,
          lengthMenu: [
            [10, 25, 50, -1],
            [10, 25, 50, "All"],
          ],
          language: {
            search: "Search Employees:",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ employees",
            infoEmpty: "No employees found",
            infoFiltered: "(filtered from _MAX_ total employees)",
          },
        });
      });

      function openAddModal() {
        isEditMode = false;
        currentEmpNo = null;
        $("#modalTitle").text("Add Employee");
        $("#employeeForm")[0].reset();
        $("#empNo").prop("readonly", false);
      }

      function editEmployee(empNo) {
        isEditMode = true;
        currentEmpNo = empNo;
        $("#modalTitle").text("Edit Employee");

        // Fetch employee data
        $.get(`/api/employees/${empNo}`, function (response) {
          const data = response.empNo ? response : response;
          $("#empNo").val(data.empNo).prop("readonly", true);
          $("#firstName").val(data.firstName);
          $("#lastName").val(data.lastName);
          $("#gender").val(data.gender);
          $("#birthDate").val(data.birthDate);
          $("#hireDate").val(data.hireDate);

          $("#employeeModal").modal("show");
        }).fail(function () {
          Swal.fire("Error", "Failed to load employee data", "error");
        });
      }

      function saveEmployee() {
        const formData = {
          empNo: parseInt($("#empNo").val()),
          firstName: $("#firstName").val(),
          lastName: $("#lastName").val(),
          gender: $("#gender").val(),
          birthDate: $("#birthDate").val(),
          hireDate: $("#hireDate").val(),
        };

        // Validation
        if (
          !formData.empNo ||
          !formData.firstName ||
          !formData.lastName ||
          !formData.gender ||
          !formData.birthDate ||
          !formData.hireDate
        ) {
          Swal.fire("Error", "Please fill all required fields", "error");
          return;
        }

        const url = isEditMode
          ? `/api/employees/${currentEmpNo}`
          : "/api/employees";
        const method = isEditMode ? "PUT" : "POST";

        $.ajax({
          url: url,
          method: method,
          contentType: "application/json",
          data: JSON.stringify(formData),
          success: function (response) {
            $("#employeeModal").modal("hide");
            table.ajax.reload();
            Swal.fire(
              "Success",
              isEditMode
                ? "Employee updated successfully"
                : "Employee added successfully",
              "success"
            );
          },
          error: function (xhr) {
            const error = xhr.responseJSON;
            let message = "An error occurred";

            if (error && error.message) {
              message = error.message;
            } else if (error && error.validationErrors) {
              message = Object.values(error.validationErrors).join("<br>");
            }

            Swal.fire("Error", message, "error");
          },
        });
      }

      function deleteEmployee(empNo) {
        Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, delete it!",
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: `/api/employees/${empNo}`,
              method: "DELETE",
              success: function () {
                table.ajax.reload();
                Swal.fire("Deleted!", "Employee has been deleted.", "success");
              },
              error: function (xhr) {
                const error = xhr.responseJSON;
                const message =
                  error && error.message
                    ? error.message
                    : "Failed to delete employee";
                Swal.fire("Error", message, "error");
              },
            });
          }
        });
      }
    </script>
  </body>
</html>
